---
# Own Machine Ansible Playbook
# Personal machine-specific configuration (deltas from base playbook)
#
# Usage:
#   ansible-playbook playbook.own.yml --ask-become-pass

- name: Configure Own Machine
  hosts: localhost
  connection: local
  become: false

  tasks:
    # ===== Personal Directories =====
    - name: Create personal directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ ansible_facts.env.HOME }}/Developer"
        - "{{ ansible_facts.env.HOME }}/Developer/personal"
        - "{{ ansible_facts.env.HOME }}/Developer/experiments"
        - "{{ ansible_facts.env.HOME }}/Documents/personal"
      tags:
        - directories

    # ===== Personal Environment File =====
    - name: Create personal environment file
      copy:
        dest: "{{ ansible_facts.env.HOME }}/.own.env"
        content: |
          # Personal environment variables
          # Source this file in your shell: source ~/.own.env

          # Personal AWS/Cloud profiles
          # export AWS_PROFILE="personal"
          # export AWS_REGION="us-west-2"

          # Personal projects
          # export PERSONAL_PROJECTS_DIR="$HOME/Developer/personal"
        mode: '0600'
        force: no
      tags:
        - environment

    # ===== macOS Personal Settings =====
    - name: Personal macOS Configuration
      block:
        - name: Set shorter screen lock delay for personal use
          community.general.osx_defaults:
            domain: com.apple.screensaver
            key: askForPasswordDelay
            type: int
            value: 60  # 1 minute for personal
          tags:
            - macos
            - security

        - name: Enable Airdrop for personal use
          command: defaults write com.apple.NetworkBrowser DisableAirDrop -bool NO
          tags:
            - macos

    # ===== Transmission BitTorrent Client =====
    - name: Create torrents directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ ansible_facts.env.HOME }}/torrents"
        - "{{ ansible_facts.env.HOME }}/torrents/incomplete"
      tags:
        - transmission

    - name: Configure Transmission
      community.general.osx_defaults:
        domain: org.m0k.transmission
        key: "{{ item.key }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
      loop:
        - { key: "DownloadFolder", type: "string", value: "{{ ansible_facts.env.HOME }}/torrents" }
        - { key: "DownloadLocationConstant", type: "bool", value: true }
        - { key: "IncompleteDownloadFolder", type: "string", value: "{{ ansible_facts.env.HOME }}/torrents/incomplete" }
        - { key: "UseIncompleteDownloadFolder", type: "bool", value: true }
        - { key: "AutoImport", type: "bool", value: true }
        - { key: "AutoImportDirectory", type: "string", value: "{{ ansible_facts.env.HOME }}/Downloads" }
        - { key: "DeleteOriginalTorrent", type: "bool", value: true }
      tags:
        - transmission


    # ===== OpenConnect VPN (passwordless sudo) =====
    - name: Allow openconnect without sudo password
      become: true
      copy:
        dest: /etc/sudoers.d/openconnect
        content: |
          %admin ALL=(ALL) NOPASSWD: /opt/homebrew/bin/openconnect
        mode: '0440'
        validate: 'visudo -cf %s'
      tags:
        - vpn
        - sudo

    # ===== Manual Setup Reminders =====
    - name: Remind to setup personal email
      debug:
        msg: "MANUAL: Add sh.vadim@gmail.com to Mail app via System Settings â†’ Internet Accounts"
      tags:
        - reminder
        - manual

    # ===== Git Configuration for Personal Repos =====
    - name: Create gitconfig for personal repositories
      copy:
        dest: "{{ ansible_facts.env.HOME }}/.gitconfig.own"
        content: |
          # Personal git configuration
          # This file is included via includeIf in main .gitconfig

          [user]
              # email = personal@example.com

          # Personal GitHub settings
          # [url "git@github.com-personal:"]
          #     insteadOf = https://github.com/
        mode: '0644'
        force: no
      tags:
        - git

  handlers:
    - name: Restart Dock
      command: killall Dock
      changed_when: false

    - name: Restart Finder
      command: killall Finder
      changed_when: false
