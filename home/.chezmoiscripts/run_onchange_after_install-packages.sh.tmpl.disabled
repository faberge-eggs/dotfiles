#!/bin/bash

# Run whenever Brewfile changes

set -e

echo "Brewfile changed, updating packages..."

# Check if Homebrew is installed
if ! command -v brew &>/dev/null; then
    echo "Homebrew not found. Skipping package update."
    exit 0
fi

# Find the Brewfiles - check multiple possible locations
BREWFILE_DIR=""
for dir in "{{ .chezmoi.sourceDir }}/.." "$HOME/.dotfiles" "{{ .chezmoi.sourceDir }}/../../dotfiles"; do
    if [ -f "$dir/Brewfile" ]; then
        BREWFILE_DIR="$dir"
        break
    fi
done

if [ -z "$BREWFILE_DIR" ]; then
    echo "Brewfile not found. Skipping package update."
    exit 0
fi

cd "$BREWFILE_DIR"

# Update common packages
if [ -f "Brewfile" ]; then
    echo "Updating common packages from Brewfile..."
    brew bundle --file=Brewfile
fi

# Update machine-specific packages
{{- if eq .machineType "workato" }}
if [ -f "Brewfile.workato" ]; then
    echo "Updating workato-specific packages from Brewfile.workato..."
    brew bundle --file=Brewfile.workato
fi
{{- else if eq .machineType "own" }}
if [ -f "Brewfile.own" ]; then
    echo "Updating personal packages from Brewfile.own..."
    brew bundle --file=Brewfile.own
fi
{{- end }}

echo "Packages updated successfully"

# Hash of Brewfile to detect changes
# Brewfile hash: {{ include (joinPath .chezmoi.sourceDir "../Brewfile") | sha256sum }}
{{- if eq .machineType "workato" }}
# Brewfile.workato hash: {{ include (joinPath .chezmoi.sourceDir "../Brewfile.workato") | sha256sum }}
{{- else if eq .machineType "own" }}
# Brewfile.own hash: {{ include (joinPath .chezmoi.sourceDir "../Brewfile.own") | sha256sum }}
{{- end }}
