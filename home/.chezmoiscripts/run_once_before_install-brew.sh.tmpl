#!/bin/bash

# Install Homebrew packages before applying dotfiles
# This script runs once before dotfiles are applied

set -e

echo "Installing Homebrew packages..."

# Check if Homebrew is installed
if ! command -v brew &>/dev/null; then
    echo "Homebrew not found. Skipping package installation."
    exit 0
fi

# Find the Brewfiles - check multiple possible locations
BREWFILE_DIR=""
for dir in "{{ .chezmoi.sourceDir }}/.." "$HOME/.dotfiles" "{{ .chezmoi.sourceDir }}/../../dotfiles"; do
    if [ -f "$dir/Brewfile" ]; then
        BREWFILE_DIR="$dir"
        break
    fi
done

if [ -z "$BREWFILE_DIR" ]; then
    echo "Brewfile not found. Skipping package installation."
    exit 0
fi

cd "$BREWFILE_DIR"

# Install common packages
if [ -f "Brewfile" ]; then
    echo "Installing common packages from Brewfile..."
    brew bundle --file=Brewfile
fi

# Install machine-specific packages
{{- if eq .machineType "workato" }}
if [ -f "Brewfile.workato" ]; then
    echo "Installing workato-specific packages from Brewfile.workato..."
    brew bundle --file=Brewfile.workato
fi
{{- else if eq .machineType "own" }}
if [ -f "Brewfile.own" ]; then
    echo "Installing personal packages from Brewfile.own..."
    brew bundle --file=Brewfile.own
fi
{{- end }}

echo "Homebrew packages installed successfully"
